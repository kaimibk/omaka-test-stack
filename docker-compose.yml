version: "3.7"
services:
    notebook-server:
        build: 
            context: .
            dockerfile: Dockerfile
        env_file:
            - .env
        volumes: 
            - ./data:/app/data
            - ./notebooks:/app/notebooks
            - ./logs:/app/logs
            - ./requirements:/app/requirements
            - ./scripts:/app/scripts
        ports:
            - "${JUPYTERPORT}:${JUPYTERPORT}"
        networks:
            omaka-server: null

    ray-head:
        image: rayproject/ray:latest-py310
        env_file:
            - .env
        ports:
            - "${REDISPORT}:${REDISPORT}"
            - "${DASHBOARDPORT}:${DASHBOARDPORT}"
            - "${HEADNODEPORT}:${HEADNODEPORT}"
        command: bash -c "ray start --head --dashboard-port=${DASHBOARDPORT} --port=${REDISPORT} --dashboard-host=0.0.0.0 --redis-password=${REDISPASSWORD} --metrics-export-port=${METRICSPORT} --block"
        shm_size: 2g
        deploy:
            resources:
                limits:
                    cpus: "1"
                    memory: "2g"
        networks:
            omaka-server: null
                    
    ray-worker:
        image: rayproject/ray:latest-py310
        depends_on:
            - ray-head
        env_file:
            - .env
        command: bash -c "ray start --address=ray-head:${REDISPORT} --redis-password=${REDISPASSWORD} --num-cpus=${NUM_CPU_WORKER} --block"
        shm_size: 2g
        deploy:
            mode: replicated
            replicas: ${NUM_WORKERS}
            resources:
                limits:
                    cpus: ${NUM_CPU_WORKER}
                    memory: "2g"
        networks:
            omaka-server: null

    prometheus:
        image: prom/prometheus:latest
        depends_on:
            - 'ray-head'
        volumes:
            - ./prometheus/config.yml:/etc/prometheus/prometheus.yml
        ports:
            - "${PROMETHEUSPORT}:${PROMETHEUSPORT}"
        networks:
            omaka-server: null

    grafana:
        image: grafana/grafana:latest
        depends_on:
            - 'prometheus'
        links:
            - prometheus:promtheus
            - ray-head:ray-head
        environment:
            - GF_AUTH_DISABLE_LOGIN_FORM=true
            - GF_AUTH_ANONYMOUS_ENABLED=true
            - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
        ports:
            - "${GRAFANAPORT}:${GRAFANAPORT}"
        volumes:
            - ./grafana/grafana_data:/var/lib/grafana
        user: "1000"
        networks:
            omaka-server: null

networks:
    omaka-server:
        name: omaka-server